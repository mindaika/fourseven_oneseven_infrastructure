name: infrastructure

services:
  # PostgreSQL - database for Home Assistant and other services
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"  # Exposed for Home Assistant on host network
    environment:
      - POSTGRES_DB=${POSTGRES_DB:-garbanzodb}
      - POSTGRES_USER=${POSTGRES_USER:-garbanzo}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - infra_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-garbanzo}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Pi-hole - network-wide ad blocking and DNS
  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    hostname: pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8080:80/tcp"  # Web interface (Pi-hole v6 web server listens on 80 internally)
    environment:
      - TZ=${TZ:-America/Los_Angeles}
      - FTLCONF_webserver_api_password=${PIHOLE_PASSWORD}
      - FTLCONF_dns_upstreams=1.1.1.1;1.0.0.1;9.9.9.9;149.112.112.112  # Cloudflare + Quad9
      - FTLCONF_dns_dnssec=true
      - FTLCONF_dns_bogusPriv=true
      - FTLCONF_dns_domainNeeded=true
      - FTLCONF_dns_listeningMode=all  # Accept queries from all interfaces
      - FTLCONF_webserver_domain=hole.garbanzo.monster
      - FTLCONF_webserver_port=80,[::]:80  # HTTPS handled by nginx
    volumes:
      - pihole_config:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    dns:
      - 1.1.1.1
      - 9.9.9.9
    cap_add:
      - NET_ADMIN
    networks:
      - infra_network
    healthcheck:
      test: ["CMD", "dig", "+short", "@127.0.0.1", "google.com"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx - reverse proxy for all web services
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    environment:
      - SYNOLOGY_ADDR=${SYNOLOGY_ADDR}
      - HA_GATEWAY_ADDR=${HA_GATEWAY_ADDR}
    volumes:
      - ./nginx/templates:/etc/nginx/templates:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - /home/mindaika/Source/fourseven_oneseven_frontend/dist:/usr/share/nginx/html:ro
      - certbot_webroot:/var/www/certbot
      - nginx_cache:/var/cache/nginx
    networks:
      - infra_network
      - apps_network
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  postgres_data:
    driver: local
  pihole_config:
    driver: local
  pihole_dnsmasq:
    driver: local
  nginx_cache:
    driver: local
  certbot_webroot:
    driver: local

networks:
  infra_network:
    name: infra_network
    driver: bridge
  apps_network:
    name: apps_network
    driver: bridge
    external: true
