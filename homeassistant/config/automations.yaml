- id: '1770434597360'
  alias: Plants on
  description: ''
  triggers:
  - trigger: time
    at: 07:00:00
  conditions: []
  actions:
  - action: switch.turn_on
    target:
      entity_id: switch.yellow_room_tapo_1_tapo_smart_plug_1
  mode: single
- id: '1770434661286'
  alias: Plants Off
  description: ''
  triggers:
  - trigger: time
    at: '19:00:00'
  conditions: []
  actions:
  - action: switch.turn_off
    target:
      entity_id: switch.yellow_room_tapo_1_tapo_smart_plug_1
  mode: single
- id: '1770438411350'
  alias: Night Lights
  description: 'Sunrise: turn off all indoor and outdoor lights, reset home state'
  triggers:
  - trigger: sun
    event: sunrise
    offset: 0
  conditions: []
  actions:
  - action: light.turn_off
    metadata: {}
    target:
      area_id:
      - porch
      - garage
    data: {}
  - action: light.turn_off
    target:
      entity_id:
      - light.schoolhouse
      - light.blue_school_lamp
      - light.old_goldie
      - light.brass_ball
      - light.swing_ball_lamp
      - light.living_room_tapo_1_tapo_smart_plug_2
    data: {}
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.home_occupied
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.asleep
  mode: single
- id: '1770438499730'
  alias: Night Lights On
  description: 'Sunset: turn on outdoor lights, activate evening scene if home'
  triggers:
  - trigger: sun
    event: sunset
    offset: 0
  conditions: []
  actions:
  - action: light.turn_on
    metadata: {}
    target:
      area_id:
      - garage
      - porch
    data:
      brightness_pct: 50
  - if:
    - condition: state
      entity_id: input_boolean.home_occupied
      state: 'on'
    then:
    - action: scene.turn_on
      metadata: {}
      target:
        entity_id: scene.evening_lights
      data: {}
    else:
    - action: light.turn_on
      target:
        entity_id: light.schoolhouse
      data: {}
    - action: light.turn_on
      target:
        entity_id: '{{ [''light.blue_school_lamp'', ''light.old_goldie'', ''light.living_room_tapo_1_tapo_smart_plug_2'']
          | random }}

          '
      data: {}
  mode: single
- id: '1771015767883'
  alias: Patio Lights On
  description: Turn on patio floods when the back door opens at night
  triggers:
  - trigger: state
    entity_id: binary_sensor.back_door_sensor
    to: 'on'
  conditions:
  - condition: sun
    after: sunset
    before: sunrise
  actions:
  - action: light.turn_on
    target:
      entity_id:
      - light.left_flood
      - light.right_flood
    data:
      brightness_pct: 100
  mode: single
- id: '1771015767884'
  alias: Patio Lights Off
  description: Turn off patio floods after 3 minutes of no motion
  triggers:
  - trigger: state
    entity_id: binary_sensor.rear_motion_sensor_occupancy
    to: 'off'
    for:
      minutes: 3
  - trigger: state
    entity_id: binary_sensor.back_door_sensor
    from: 'on'
    to: 'off'
    for:
      minutes: 3
  conditions:
  - condition: sun
    after: sunset
    before: sunrise
  - condition: state
    entity_id: light.left_flood
    state: 'on'
  - condition: state
    entity_id: binary_sensor.rear_motion_sensor_occupancy
    state: 'off'
  actions:
  - action: light.turn_off
    target:
      entity_id:
      - light.left_flood
      - light.right_flood
  mode: restart
- id: '1738000000001'
  alias: Departure Detection
  description: 'Detect departure: door closes, wait 7 min, check outdoor motion clear
    and home_occupied hasn''t changed recently (prevents false trigger on arrival)'
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.front_door_sensor
    - binary_sensor.back_door_sensor
    from: 'on'
    to: 'off'
  conditions:
  - condition: state
    entity_id: input_boolean.home_occupied
    state: 'on'
  - condition: time
    after: 06:00:00
    before: '22:00:00'
  actions:
  - delay:
      minutes: 7
  - condition: state
    entity_id: binary_sensor.front_porch_sensor_occupancy
    state: 'off'
  - condition: state
    entity_id: binary_sensor.rear_motion_sensor_occupancy
    state: 'off'
  - condition: template
    value_template: '{{ (now() - states.input_boolean.home_occupied.last_changed).total_seconds()
      > 600 }}'
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.home_occupied
  - if:
    - condition: sun
      after: sunset
      before: sunrise
    then:
    - action: light.turn_off
      target:
        entity_id:
        - light.brass_ball
        - light.swing_ball_lamp
        - light.blue_school_lamp
        - light.old_goldie
        - light.living_room_tapo_1_tapo_smart_plug_2
      data: {}
    - action: light.turn_on
      target:
        entity_id: light.schoolhouse
      data: {}
    - action: light.turn_on
      target:
        entity_id: '{{ [''light.blue_school_lamp'', ''light.old_goldie'', ''light.living_room_tapo_1_tapo_smart_plug_2'']
          | random }}

          '
      data: {}
  mode: restart
- id: '1738000000002'
  alias: Arrival Detection
  description: 'Detect arrival: any door opens while home_occupied is off. Set home_occupied
    to on and restore evening lights if dark.'
  triggers:
  - trigger: state
    entity_id:
    - binary_sensor.front_door_sensor
    - binary_sensor.back_door_sensor
    to: 'on'
  conditions:
  - condition: state
    entity_id: input_boolean.home_occupied
    state: 'off'
  - condition: time
    after: 06:00:00
    before: '22:00:00'
  actions:
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.home_occupied
  - if:
    - condition: sun
      after: sunset
      before: sunrise
    then:
    - action: scene.turn_on
      target:
        entity_id: scene.evening_lights
      data: {}
  mode: single
- id: '1738000000003'
  alias: Bedtime Lights Off
  description: When master bedroom door closes at night, turn off all lights except
    Swing Ball Lamp including porch and garage
  triggers:
  - trigger: state
    entity_id: binary_sensor.master_bedroom_door_sensor
    from: 'on'
    to: 'off'
  conditions:
  - condition: sun
    after: sunset
    before: sunrise
  - condition: state
    entity_id: input_boolean.home_occupied
    state: 'on'
  actions:
  - action: light.turn_off
    target:
      entity_id:
      - light.schoolhouse
      - light.blue_school_lamp
      - light.old_goldie
      - light.brass_ball
      - light.living_room_tapo_1_tapo_smart_plug_2
    data: {}
  - action: light.turn_off
    target:
      area_id:
      - porch
      - garage
    data: {}
  mode: single
- id: '1738000000004'
  alias: Morning Wake Up Light
  description: When bedroom door opens after 5AM before sunrise with bedside lamp
    on, turn on a random downstairs lamp
  triggers:
  - trigger: state
    entity_id: binary_sensor.master_bedroom_door_sensor
    from: 'off'
    to: 'on'
  conditions:
  - condition: sun
    before: sunrise
  - condition: time
    after: 05:00:00
  - condition: state
    entity_id: input_boolean.home_occupied
    state: 'on'
  - condition: numeric_state
    entity_id: sensor.bedroom_tapo_1_top_current_consumption
    above: 5
  actions:
  - action: light.turn_on
    target:
      entity_id: '{{ [''light.blue_school_lamp'', ''light.old_goldie'', ''light.living_room_tapo_1_tapo_smart_plug_2'']
        | random }}'
    data: {}
  mode: single
- id: '1739600000001'
  alias: Receiver On When WiiM Playing
  description: Turn on the Yamaha receiver when WiiM starts playing
  triggers:
  - trigger: state
    entity_id: media_player.wiim_2
    to: playing
  actions:
  - action: media_player.turn_on
    target:
      entity_id: media_player.dont_use
  - action: media_player.select_source
    target:
      entity_id: media_player.dont_use
    data:
      source: Optical
  mode: single
- id: 'bedtime_sleep_detection'
  alias: Bedtime Sleep Detection
  description: First time bedside lamp turns off at night, turn off Swing Ball and
    Schoolhouse and mark as asleep until 5AM
  triggers:
  - trigger: numeric_state
    entity_id: sensor.bedroom_tapo_1_top_current_consumption
    below: 5
  conditions:
  - condition: sun
    after: sunset
    before: sunrise
  - condition: state
    entity_id: input_boolean.asleep
    state: 'off'
  - condition: state
    entity_id: input_boolean.home_occupied
    state: 'on'
  actions:
  - action: light.turn_off
    target:
      entity_id:
      - light.swing_ball_lamp
      - light.schoolhouse
    data: {}
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.asleep
  mode: single
- id: 'reset_asleep_flag'
  alias: Reset Asleep Flag
  description: Reset asleep flag at 5AM to enable morning automations
  triggers:
  - trigger: time
    at: '05:00:00'
  conditions: []
  actions:
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.asleep
  mode: single
- id: 'porch_motion_lights'
  alias: Porch Motion Lights
  description: Turn on porch lights on front motion at night, stay on for 5 minutes
    after motion clears
  triggers:
  - trigger: state
    entity_id: binary_sensor.front_porch_sensor_occupancy
    to: 'on'
  conditions:
  - condition: sun
    after: sunset
    before: sunrise
  actions:
  - action: light.turn_on
    target:
      area_id: porch
    data:
      brightness_pct: 100
  - wait_for_trigger:
    - trigger: state
      entity_id: binary_sensor.front_porch_sensor_occupancy
      to: 'off'
    timeout:
      minutes: 30
  - delay:
      minutes: 5
  - action: light.turn_off
    target:
      area_id: porch
  mode: restart
- id: 'hvac_fans_on'
  alias: Fans On With HVAC
  description: When HVAC starts heating or cooling, snapshot all fan states and turn
    them on for air circulation
  triggers:
  - trigger: state
    entity_id: climate.my_ecobee
    attribute: hvac_action
    to: heating
  - trigger: state
    entity_id: climate.my_ecobee
    attribute: hvac_action
    to: cooling
  conditions:
  - condition: state
    entity_id: input_boolean.hvac_fan_control
    state: 'off'
  actions:
  - action: scene.create
    data:
      scene_id: hvac_fan_snapshot
      snapshot_entities:
      - fan.mid_fan
      - fan.cat_fan
      - fan.big_vornado
      - fan.silver_vornado
      - fan.tiny_fan
  - action: fan.turn_on
    target:
      entity_id:
      - fan.mid_fan
      - fan.cat_fan
      - fan.big_vornado
      - fan.silver_vornado
      - fan.tiny_fan
  - action: input_boolean.turn_on
    target:
      entity_id: input_boolean.hvac_fan_control
  mode: single
- id: 'hvac_fans_restore'
  alias: Fans Restore After HVAC
  description: When HVAC stops heating or cooling, restore all fans to their prior
    state
  triggers:
  - trigger: state
    entity_id: climate.my_ecobee
    attribute: hvac_action
    to: idle
  - trigger: state
    entity_id: climate.my_ecobee
    attribute: hvac_action
    to: 'off'
  conditions:
  - condition: state
    entity_id: input_boolean.hvac_fan_control
    state: 'on'
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.hvac_fan_snapshot
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.hvac_fan_control
  mode: single
- id: 'humidifier_fan_on'
  alias: Yellow Room Fan On With Humidifier
  description: When humidifier starts drawing power, turn on Mid Fan if it was off
    and track that we turned it on
  triggers:
  - trigger: numeric_state
    entity_id: sensor.yellow_room_tapo_1_bottom_current_consumption
    above: 10
  conditions: []
  actions:
  - if:
    - condition: state
      entity_id: fan.mid_fan
      state: 'off'
    then:
    - action: fan.turn_on
      target:
        entity_id: fan.mid_fan
    - action: input_boolean.turn_on
      target:
        entity_id: input_boolean.humidifier_fan_control
    else:
    - action: input_boolean.turn_off
      target:
        entity_id: input_boolean.humidifier_fan_control
  mode: single
- id: 'humidifier_fan_restore'
  alias: Yellow Room Fan Restore After Humidifier
  description: When humidifier stops drawing power, turn off Mid Fan only if we
    turned it on
  triggers:
  - trigger: numeric_state
    entity_id: sensor.yellow_room_tapo_1_bottom_current_consumption
    below: 10
    for:
      seconds: 10
  conditions:
  - condition: state
    entity_id: input_boolean.humidifier_fan_control
    state: 'on'
  actions:
  - action: fan.turn_off
    target:
      entity_id: fan.mid_fan
  - action: input_boolean.turn_off
    target:
      entity_id: input_boolean.humidifier_fan_control
  mode: single
- id: 'bedside_button_control'
  alias: Bedside Button Control
  description: 'SNZB-01P button: single=sunset fade, double=off, long=sunrise fade'
  triggers:
  - trigger: event
    event_type: zha_event
    event_data:
      # TODO: Replace with actual device_ieee of your SNZB-01P
      device_ieee: '00:00:00:00:00:00:00:00'
      command: toggle
    id: single
  - trigger: event
    event_type: zha_event
    event_data:
      device_ieee: '00:00:00:00:00:00:00:00'
      command: both_buttons
    id: double
  - trigger: event
    event_type: zha_event
    event_data:
      device_ieee: '00:00:00:00:00:00:00:00'
      command: long_press
    id: long
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: trigger
        id: single
      sequence:
      - action: script.bedside_sunset
    - conditions:
      - condition: trigger
        id: double
      sequence:
      - action: script.turn_off
        target:
          entity_id: script.bedside_sunset
      - action: script.turn_off
        target:
          entity_id: script.bedside_sunrise
      - action: light.turn_off
        target:
          entity_id: light.bedside_lamp
    - conditions:
      - condition: trigger
        id: long
      sequence:
      - action: script.bedside_sunrise
  mode: single
- id: 'spring_equinox_yard'
  alias: Spring Equinox Yard
  description: Apply Spring Yard scene on the first day of spring (March 20)
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: template
    value_template: "{{ now().month == 3 and now().day == 20 }}"
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.spring_yard
  mode: single
- id: 'summer_solstice_yard'
  alias: Summer Solstice Yard
  description: Apply Summer Yard scene on the first day of summer (June 20)
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: template
    value_template: "{{ now().month == 6 and now().day == 20 }}"
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.summer_yard
  mode: single
- id: 'autumn_equinox_yard'
  alias: Autumn Equinox Yard
  description: Apply Autumn Yard scene on the first day of fall (September 22)
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: template
    value_template: "{{ now().month == 9 and now().day == 22 }}"
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.autumn_yard
  mode: single
- id: 'winter_solstice_yard'
  alias: Winter Solstice Yard
  description: Apply Winter Yard scene on the first day of winter (December 21)
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: template
    value_template: "{{ now().month == 12 and now().day == 21 }}"
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.winter_yard
  mode: single
- id: 'st_patricks_day_porch'
  alias: St. Patrick's Day Porch
  description: Apply Irish Flag Porch scene on St. Patrick's Day (March 17)
  triggers:
  - trigger: time
    at: '16:00:00'
  conditions:
  - condition: template
    value_template: "{{ now().month == 3 and now().day == 17 }}"
  actions:
  - action: scene.turn_on
    target:
      entity_id: scene.irish_flag_porch
  mode: single
- id: 'morning_yard_reset'
  alias: Morning Yard Reset
  description: At midnight, apply the day's special scene or restore to neutral
  triggers:
  - trigger: time
    at: '00:00:00'
  conditions: []
  actions:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ now().month == 3 and now().day == 17 }}"
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.irish_flag_porch
    - conditions:
      - condition: template
        value_template: "{{ now().month == 3 and now().day == 20 }}"
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.spring_yard
    - conditions:
      - condition: template
        value_template: "{{ now().month == 6 and now().day == 20 }}"
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.summer_yard
    - conditions:
      - condition: template
        value_template: "{{ now().month == 9 and now().day == 22 }}"
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.autumn_yard
    - conditions:
      - condition: template
        value_template: "{{ now().month == 12 and now().day == 21 }}"
      sequence:
      - action: scene.turn_on
        target:
          entity_id: scene.winter_yard
    default:
    - action: scene.turn_on
      target:
        entity_id: scene.yard_ambience
    - action: scene.turn_on
      target:
        entity_id: scene.porch_neutral
  mode: single
